# Workshop #2 Guide: Automating Tasks with Macros and VBA in Excel

This document serves as a guide based on the "Workshop #2.mp4" video, outlining the process of using macros and VBA for automating tasks in Excel, particularly data cleaning and consolidation.

## Introduction to Macros

*   A **macro** is defined as a **set of automated instructions that perform repetitive tasks quickly**.
*   Macros are written in **VBA (Visual Basic for Applications)**.
*   VBA is the programming language, and macros are the automated instructions created using this language. This is likened to Python being the language and scripts written in Python being analogous to macros.
*   Macros in Excel can be used for a multitude of reasons.

## Creating a Macro

There are two primary ways to create a macro in Excel:

*   **Recording a Macro**: This method allows you to perform a task manually in Excel, and Excel automatically writes the necessary VBA code to replicate those steps. This is described as a really easy way to get started.
*   **Writing a Macro from Scratch**: This involves directly writing VBA code in the VBA editor. This approach offers **more versatility**, especially when the automation involves tasks beyond standard Excel operations or requires more complex logic. For the workshop's purpose, writing macros from scratch will be necessary.

## Data Cleaning Review

Before recording or writing macros for automation, the video reviews a data cleaning process using Excel formulas on the "customers" sheet.

*   **Objective**: To remove quotation marks and trailing forward slashes from text data and format dates.
*   **Formula used**:
```

=IF(LEFT(A2,1)="""",IF(RIGHT(A2,1)="""",MID(A2,2,LEN(A2)-2),A2),IF(RIGHT(A2,1)="/",LEFT(A2,LEN(A2)-1),A2))
```
*   This formula checks if the leftmost character is a quotation mark (`"`). If so, it then checks if the rightmost character is also a quotation mark. If both are true, it extracts the middle part of the text, effectively removing the quotation marks.
*   If the initial check for quotation marks fails, it then checks if the rightmost character is a forward slash (`/`). If it is, it keeps the leftmost characters excluding the last one, removing the slash.
*   If neither of these conditions is met, the formula keeps the original cell value.
*   **Date Formatting**: To format the "created at" column, the `TEXT` function is added to the existing formula:
```
=TEXT(IF(LEFT(A2,1)="""",IF(RIGHT(A2,1)="""",MID(A2,2,LEN(A2)-2),A2),IF(RIGHT(A2,1)="/",LEFT(A2,LEN(A2)-1),A2)),"mm/dd/yyyy hh:mm")

```
*   The `TEXT` function takes a value (the result of the previous `IF` statement) and formats it according to the specified format code ("mm/dd/yyyy hh:mm" in this case).

## Recording a Macro

The video demonstrates how to record a macro using the "employees" sheet as an example. The steps differ slightly between Dell (Windows) and Mac computers.

### Accessing the Developer Tab

*   **Dell (Windows)**: Go to **File > Options > Customize Ribbon**, and then check the **Developer** box in the main tabs list.
*   **Mac**: Go to **Excel > Preferences > Ribbon & Toolbar**, and then check the **Developer** box under the main tabs.

### Steps to Record a Macro

1.  With the **Developer** tab visible, click on **Record Macro**.
2.  In the "Record Macro" dialog box:
    *   Enter a **Macro name** (e.g., `cleaning_employees`). **Important**: Macro names cannot contain spaces; use an underscore (`_`) to separate words.
    *   You can add a **Description** (optional).
    *   You can assign a **Shortcut key** (optional).
3.  Click **OK** to start recording. Excel will now record all your actions.
4.  Perform the data cleaning steps (as reviewed earlier) on the "employees" sheet.
5.  Once the cleaning is complete, go to the **Developer** tab and click **Stop Recording**.

### Viewing the Recorded Macro (VBA Code)

*   To view the VBA code generated by the recorded macro, you can:
    *   Go to the **Developer** tab and click **Macros**. Select the recorded macro and click **Edit**. This will open the VBA editor.
    *   Alternatively, from the **Developer** tab, click on **Visual Basic** to open the VBA editor directly. In the VBA editor, look for the module where the macro was recorded (usually in **Module1**).

*   The recorded macro will show the VBA code corresponding to the steps you performed in Excel. This code might be lengthy, illustrating why writing it from scratch can be complex for simple tasks.

## Writing a Macro from Scratch: Automating Data Cleaning for Multiple Files

The video then transitions to writing a macro from scratch to automate the data cleaning process for multiple "purchases" data files and consolidate them into a single "target" workbook.

### Understanding the VBA Code Structure

The provided VBA code (not fully written out in the video, but explained through slides) aims to:

1.  **Define variables**: Use `Dim` statements to declare the data types of variables that will be used in the macro.
    *   `folderPath As String`: Stores the path to the folder containing the data files.
    *   `WbSource As Workbook`: Represents the workbook that is currently being processed (a purchases file).
    *   `WbTarget As Workbook`: Represents the target workbook where the cleaned data will be consolidated.
    *   `Ws As Worksheet`: Represents a worksheet within a workbook.
    *   `targetFileName As String`: Stores the name of the target workbook file.
    *   `fileName As String`: Stores the name of the current file being processed.

2.  **Set up the target workbook**:
    *   Specify the `folderPath` where the data files are located.
    *   Define the `targetFileName` (e.g., "target\_workbook.xlsm").
    *   Combine the `folderPath` and `targetFileName` to create the full path for the target workbook.
    *   The code includes `Set WbTarget = Workbooks.Add` and `WbTarget.SaveAs` which are intended to create and save the target workbook. However, the presenter notes that the files are actually being uploaded into a pre-existing target workbook, and the exact behavior of these lines is unclear.
    *   `Application.DisplayAlerts = False` suppresses Excel pop-up messages.
    *   `Application.DisplayAlerts = True` re-enables the alerts.
    *   The code includes steps to ensure the target workbook has at least one sheet to prevent errors during pasting.

3.  **Open and process purchase files**:
    *   Use the `Dir` function to get the name of the first file in the `folderPath` that matches a specific pattern (`"2024-*\ _purchases"`). The asterisk (`*`) acts as a wildcard. This pattern is designed to identify all the monthly purchases files (e.g., "2024-01\_purchases", "2024-02\_purchases", etc.).
    *   A `Do While` loop is used to iterate through all the files that match the pattern. The loop continues as long as a `fileName` is found.
    *   `Debug.Print` statements are used for debugging, displaying messages in the Immediate Window (Ctrl+G in the VBA editor on Windows) to track the macro's progress (e.g., "Processing file...", "Opening file...").
    *   An `If InStr(fileName, "_purchases") > 0 Then` statement ensures that the code only proceeds if the current `fileName` contains "_purchases", further filtering the files.
    *   `Set WbSource = Workbooks.Open(folderPath & fileName)` opens the current purchases file.
    *   `Call Module1.Cleaning_Macro` (or a similar name based on the recorded macro) calls the previously recorded macro that performs the data cleaning steps on the opened purchases file. **Crucially, the recorded cleaning macro needs to have `Public` before `Sub` in its definition in Module1 to be callable from another module**.

4.  **Copy cleaned data to the target workbook**:
    *   A `For Each` loop iterates through each worksheet in the `WbSource` (the currently open purchases file).
    *   `Ws.Copy After:=WbTarget.Sheets(WbTarget.Sheets.Count)` copies each sheet from the source workbook to the end of the target workbook. `Next Ws` moves to the next worksheet in the source workbook.

5.  **Move to the next file**:
    *   `fileName = Dir` moves to the next file in the folder that matches the specified pattern, continuing the `Do While` loop.

6.  **Close the loop**:
    *   `Loop` closes the `Do While` loop.

7.  **Final touches**:
    *   Error handling (`On Error Resume Next`) is used to handle potential issues when removing the default sheet in the target workbook.
    *   The code attempts to delete the initial default sheet from the `WbTarget`.
    *   `WbTarget.Save` saves the target workbook.
    *   The presenter mentions issues with reliably closing all source workbooks while keeping the target workbook open and looping through all purchase files, indicating this part of the code might be incomplete or require adjustments.
    *   A message box (`MsgBox`) is intended to appear upon completion: `"Data consolidation cleaning complete"`.

### Example VBA Code Snippets (Illustrative - May Not Be Exact)

```
`Sub ConsolidateAndClean()

    Dim folderPath As String
    Dim WbSource As Workbook
    Dim WbTarget As Workbook
    Dim Ws As Worksheet
    Dim targetFileName As String
    Dim fileName As String

    ' Define the path to the folder containing the data files
    folderPath = "/Users/YourUsername/Documents/DataFiles/" ' Replace with your actual path (use "/" for Mac, "\" for Dell)

    ' Define the name of the target workbook
    targetFileName = "target_workbook.xlsm"

    ' Create the full path for the target workbook
    Dim targetFullPath As String
    targetFullPath = folderPath & targetFileName

    ' Create a new target workbook (note: behavior discussed in video)
    ' Set WbTarget = Workbooks.Add
    ' Application.DisplayAlerts = False
    ' WbTarget.SaveAs Filename:=targetFullPath, FileFormat:=xlOpenXMLWorkbookMacroEnabled
    ' Application.DisplayAlerts = True

    ' Set the target workbook if it already exists
    On Error Resume Next
    Set WbTarget = Workbooks.Open(targetFullPath)
    On Error GoTo 0
    If WbTarget Is Nothing Then
        Set WbTarget = Workbooks.Add
        Application.DisplayAlerts = False
        WbTarget.SaveAs Filename:=targetFullPath, FileFormat:=xlOpenXMLWorkbookMacroEnabled
        Application.DisplayAlerts = True
    End If

    ' Ensure at least one sheet exists in the target workbook
    If WbTarget.Sheets.Count = 0 Then
        WbTarget.Sheets.Add
    End If

    ' Get the name of the first purchases file
    fileName = Dir(folderPath & "2024-*\ _purchases")

    ' Loop through all matching files
    Do While fileName <> ""
        Debug.Print "Processing file: " & fileName
        If InStr(fileName, "_purchases") > 0 Then
            Debug.Print "Opening file: " & folderPath & fileName
            Set WbSource = Workbooks.Open(folderPath & fileName)

            ' Call the recorded cleaning macro (assuming it's named Cleaning_Macro in Module1 and is Public)
            Call Module1.Cleaning_Macro

            ' Copy each sheet to the target workbook
            For Each Ws In WbSource.Sheets
                Debug.Print "Copying sheet: " & Ws.Name
                Ws.Copy After:=WbTarget.Sheets(WbTarget.Sheets.Count)
            Next Ws

            ' Close the source workbook (commented out in the video due to issues)
            ' WbSource.Close SaveChanges:=False
        End If

        ' Get the next file name
        fileName = Dir
    Loop

    ' Remove the default sheet (if it exists)
    On Error Resume Next
    Application.DisplayAlerts = False
    WbTarget.Sheets("Sheet1").Delete ' May need to adjust sheet name
    Application.DisplayAlerts = True
    On Error GoTo 0

    ' Save the target workbook
    WbTarget.Save

    ' Display a completion message
    MsgBox "Data consolidation cleaning complete"

End Sub`
```
